{% extends "mdtui/base.html" %}
{% load index_keys %}

{% block body_content %}
    <h1>{% block body_title %}Document Search{% endblock %}</h1>

    {% if step != None %}
    {# Use this for a progress / step indicator / navigation #}
    <ul class="pager x-progress-tracker">
        {% url mdtui-search-type as url %}
        <li{% if request.path == url %} class="active"{% endif %}><a href="{{ url }}">Step 1: Select Type &rarr;</a></li>
        {% url mdtui-search-options as url %}
        <li{% if request.path == url %} class="active"{% endif %}><a href="{{ url }}">Step 2: Options &rarr;</a></li>
        {% url mdtui-search-results as url %}
        <li{% if request.path == url %} class="active"{% endif %}><a href="{{ url }}">Step 3: Results &rarr;</a></li>
        <li{% if step == "view" %} class="active"{% endif %}><a>Step 4: View</a></li>
    </ul>
    {% endif %}

    {# WARNINGS HANDLER #}
    {% if warnings %}
    {% for warning in warnings %}
    <div class="alert">
        <a class="close">×</a>
        <strong>{{ warning }}</strong>
    </div>
    {% endfor %}
    {% endif %}

    {% if step == None %} {# This step will no long be visible #}
        <p>This is where it begins...</p>
        <a class="btn btn-primary btn-large" href="{% url mdtui-search-type %}">Start <i class="icon-chevron-right icon-white"></i></a>
    {% endif %}

    {% if step == "type" %}
        <form class="form-horizontal" action="{{ request.path }}" method="post">
            {% csrf_token %}
            <fieldset>
                <legend>Step {{ step }}: Select Document Type</legend>
                {{ form }}
            </fieldset>

            <div class="form-actions">
                <button type="submit" class="btn btn-danger"><i class="icon-trash icon-white"></i> Cancel</button>
                <button type="submit" class="btn btn-primary">Continue <i class="icon-chevron-right icon-white"></i></button>
            </div>
        </form>
    {% endif %} {# end step 1 #}

    {% if step == "options" %}
        <form class="form-horizontal" action="{{ request.path }}" method="post">
            {% csrf_token %}
            <fieldset>
                <legend>Search Options</legend>

                <br />
                {% comment %}
                <div class="alert alert-error">

                    <a class="close">×</a>
                    <strong>Error!</strong> Form validation errors go here! (field validation errors go along each field below)
                </div>
                {% endcomment %}
<div>
{% comment %}
                <div class="control-group">
                    <label class="control-label" for="optionsCheckboxList">Document Types</label>
                    <div class="controls">
                        <label class="checkbox">
                            <input type="checkbox" name="optionsCheckboxList1" value="option1">
                            Employee Forms
                        </label>
                        <label class="checkbox">
                            <input type="checkbox" name="optionsCheckboxList2" value="option2">
                            Legal Documents
                        </label>
                        <label class="checkbox">
                            <input type="checkbox" name="optionsCheckboxList3" value="option3">
                            Tax Declarations
                        </label>
                        <p class="help-block"><strong>Note:</strong> Specify document types or leave blank to search all types.</p>
                    </div>
                </div>
{% endcomment %}
{% comment %}
                {# NB, these date selectors could be better done. Eg see http://addyosmani.github.com/jquery-ui-bootstrap/ #}
                <div class="control-group">
                    <label class="control-label" for="dateselect_from">From Date</label>
                    <div class="input">
                        <div class="controls">
                            <div class="input-prepend">
                                <span class="add-on"><i class="icon-calendar"></i></span>
                                <input data-datepicker="datepicker" class="input-medium" type="text" value="" id="dateselect_from" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label" for="dateselect_to">To Date</label>
                    <div class="input">
                        <div class="controls">
                            <div class="input-prepend">
                                <span class="add-on"><i class="icon-calendar"></i></span>
                                <input data-datepicker="datepicker" class="input-medium" type="text" value="" id="dateselect_to" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label" for="input01">Key 1 Label</label>
                    <div class="controls">
                        <input type="text" class="input-medium" id="input01">
                        <p class="help-block">Key 1 Desc</p>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label" for="input01">Key 2 Label</label>
                    <div class="controls">
                        <input type="text" class="input-medium" id="input02">
                        <p class="help-block">Key 2 Desc</p>
                    </div>
                </div>

                <div class="control-group">
                    <label class="control-label" for="input01">Key 3 Label</label>
                    <div class="controls">
                        <input type="text" class="input-medium" id="input03">
                        <p class="help-block">Key 3 Desc</p>
                    </div>
                </div>
{% endcomment %}
</div>

                {# SEARCH INDEX DETAILS FORM RENDERING #}
                {% for field in form %}
                {%  if not field.name == "date" %}
                <div class="control-group">
                    {%  if field.errors %}
                    {%  for error in field.errors %}
                    <div class="alert alert-error">
                        <a class="close">×</a>
                        <strong>{{ error }}</strong>
                    </div>
                    {%  endfor %}
                    {%  endif %}
                    <label class="control-label">{{ field.label }}</label>
                    <div class="controls">
                        {{ field }}
                        <p class="help-block">{{ field.help_text }}</p>
                    </div>
                </div>
                {%  else %}
                <div class="control-group">
                    {%  if field.errors %}
                    {%  for error in field.errors %}
                    <div class="alert alert-error">
                        <a class="close">×</a>
                        <strong>{{ error }}</strong>
                    </div>
                    {%  endfor %}
                    {%  endif %}
                    <label class="control-label" for="dateselect">Creation Date</label>
                    <div class="input">
                        <div class="controls">
                            <div class="input-prepend">
                                <span class="add-on"><i class="icon-calendar"></i></span>
                                <input id="id_date" type="text" value="{{ field.value|date:'Y-m-d' }}" name="{{ field.name }}" data-datepicker="datepicker">
                                <p class="help-block">{{ field.help_text }}</p>
                            </div>
                        </div>
                    </div>
                </div>
                {%  endif %}
                {%  endfor %}
            </fieldset>

            <div class="form-actions">
                <button type="submit" class="btn btn-danger"><i class="icon-repeat icon-white"></i> Reset</button>
                <button type="submit" class="btn btn-primary">Search <i class="icon-search icon-white"></i></button>
            </div>
        </form>
    {% endif %}

    {% if step == "results" %}
        <fieldset>
            <legend>Results</legend>
        </fieldset>

        <table class="table table-striped" id="results-table">
            <caption>Search with keys:
                <ul class="metainfo">
                {% for item in document_keys %}
                        <li>{% get_key_li_item document_keys item %}</li>
                {% endfor %}
                </ul>
            </caption>
            <thead>
                <tr>
                    <th>View</th>
                    <th><a href="{# sort on this#}">Date</a></th>
                    {% for key in mdts %}
                    <th><a href="{# sort on this#}">{{ key }}</a></th>
                    {% endfor %}
                    <th><a href="{# sort on this#}">Description</a></th>
                    <th><a href="{# sort on this#}">Type</a></th>
                    <th>Edit</th>
                </tr>
            </thead>
            <tbody>
            {% for doc in documents %}
                <tr>
                    <td><a href="{% url mdtui-search-view doc.id %}" title="View Document"><i class="icon-download"></i> {{ doc.id }}</a></td>
                    <td>{{ doc.metadata_created_date|date:"Y-m-d" }}</td>
                    
                    {% for key in mdts %}
                    <td>{% get_sec_key_for_doc doc.mdt_indexes key %}</td>
                    {% endfor %}

                    <td>{{ doc.metadata_description }}</td>
                    <td>{% get_docrule_name_by_id doc.metadata_doc_type_rule_id %}</td>
                    <td>{# Admin only #}<a href="" title="Edit Metadata"><i class="icon-edit"></i></a></td>
                </tr>
            {% endfor %}
            </tbody>
        </table>

        <hr />
        <p>{# TODO: show number of results fount #} Showing 50 of 1,232,300 results matching query.</p>
        {# Let's use pagination like this #}
        <div class="pagination">
            <ul>
                <li><a href="#">Prev</a></li>
                <li class="active">
                    <a href="#">1</a>
                </li>
                <li><a href="#">2</a></li>
                <li><a href="#">3</a></li>
                <li><a href="#">4</a></li>
                <li><a href="#">Next</a></li>
            </ul>
        </div>
        
        <a href="" title="Download Results to CSV" class="btn"><i class="icon-download-alt"></i> Export Results</a>

    {% endif %}

    {% if step == "view" %}
        <fieldset>
            <legend>Step 4: Viewing Document &ldquo;{{ code }}&rdquo;</legend>
        </fieldset>
        {# Maybe, don't actually display this step, just pop up a document. #}
        <div id="pdfobj"></div>
            <a href="{% url api_file %}?filename={{ code }}">DOWNLOAD document &ldquo;{{ code }}&rdquo;</a>
    {% endif %}

{% endblock %}

{% block css_extra %}
    <style type="text/css">
        #results-table tbody tr.highlight { text-decoration: underline; cursor: pointer; }
        #body-content {
            background-image: url("{{ STATIC_URL }}search-background.png");
            background-repeat: no-repeat;
            background-position: 100px 166px;
        }
        .metainfo { list-style: none; border-collapse: collapse; }
    </style>
{% endblock %}

{% block js_extra %}
    {% if step == "results" %}
    <script type="text/javascript">
        $(document).ready(function(){
            // Hide the first cell for JavaScript enabled browsers.
            //$('#link-table td:first-child').hide();

            // Apply a class on mouse over and remove it on mouse out.
            $('#results-table tbody tr').hover(function() {
                $(this).toggleClass('highlight');
            });

            // Assign a click handler that grabs the URL
            // from the first cell and redirects the user.
            $('#results-table tbody tr').click(function() {
                location.href = $(this).find('td a').attr('href');
            });
        });

    </script>
    {% endif %}
    {% if step == "options" %}{% include "mdtui/_typeaheadjs.html" %}{% endif %}
    {% if step == "view" %}
    <script type="text/javascript" language="javascript" charset="utf-8" src="{{ STATIC_URL }}js/pdfobject.min.js"></script>
    <script type='text/javascript'>
        function embedPDF(){
            var myPDF = new PDFObject({
                url: '{% url api_file %}?filename={{ code }}.pdf', //This assumes source is convertible to a PDF
                pdfOpenParams: { view: 'Fit', scrollbars: '0', toolbar: '0', statusbar: '0', messages: '0', navpanes: '0' }
            }).embed('pdfobj');
        }
        window.onload = embedPDF; //Feel free to replace window.onload if needed.
    </script>
    {% endif %}
{% endblock %}